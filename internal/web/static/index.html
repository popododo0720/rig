<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rig Dashboard</title>
<style>
/* ═══════════════════════════════════════════════════════════
   DESIGN SYSTEM — Ink & Ember
   Dark editorial aesthetic with warm amber accents.
   Typography: system monospace for data, geometric sans for UI.
   ═══════════════════════════════════════════════════════════ */

:root {
  /* Surface palette — deep charcoal with subtle warmth */
  --surface-0: #0c0b0e;
  --surface-1: #141318;
  --surface-2: #1c1b22;
  --surface-3: #25242c;
  --surface-4: #302f38;

  /* Text */
  --text-primary: #e8e4df;
  --text-secondary: #9b9592;
  --text-muted: #5e5a57;
  --text-inverse: #0c0b0e;

  /* Accent — warm amber / ember */
  --accent: #e8a44a;
  --accent-dim: #c4883a;
  --accent-glow: rgba(232, 164, 74, 0.12);
  --accent-glow-strong: rgba(232, 164, 74, 0.25);

  /* Status palette */
  --status-queued: #5e5a57;
  --status-active: #5b9ee9;
  --status-deploying: #e2c84b;
  --status-testing: #e09640;
  --status-completed: #5cc989;
  --status-failed: #e05c5c;
  --status-rollback: #b07ce0;
  --status-awaiting: #e8a44a;

  /* Spacing scale */
  --sp-1: 4px;
  --sp-2: 8px;
  --sp-3: 12px;
  --sp-4: 16px;
  --sp-5: 24px;
  --sp-6: 32px;
  --sp-7: 48px;
  --sp-8: 64px;

  /* Radius */
  --radius-s: 4px;
  --radius-m: 8px;
  --radius-l: 16px;

  /* Transitions */
  --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
  --duration-fast: 150ms;
  --duration-normal: 300ms;
  --duration-slow: 500ms;

  /* Noise overlay (inline SVG data URI) */
  --noise: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  font-family: "SF Mono", "Cascadia Code", "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.5;
  background: var(--surface-0);
  color: var(--text-primary);
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* Noise texture overlay on body */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: var(--noise);
  pointer-events: none;
  z-index: 9999;
}

/* ─── LAYOUT ─── */
.app {
  display: grid;
  grid-template-rows: auto 1fr;
  grid-template-columns: 240px 1fr;
  height: 100vh;
}

/* ─── TOP BAR ─── */
.topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--sp-3) var(--sp-5);
  background: var(--surface-1);
  border-bottom: 1px solid var(--surface-3);
  z-index: 10;
}

.topbar__brand {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}

.topbar__logo {
  width: 28px;
  height: 28px;
  background: var(--accent);
  border-radius: var(--radius-s);
  display: grid;
  place-items: center;
  font-weight: 700;
  font-size: 14px;
  color: var(--text-inverse);
  letter-spacing: -0.5px;
}

.topbar__title {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: -0.3px;
  color: var(--text-primary);
}

.topbar__project {
  font-size: 12px;
  color: var(--text-muted);
  margin-left: var(--sp-2);
  padding-left: var(--sp-3);
  border-left: 1px solid var(--surface-4);
}

.topbar__status {
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  font-size: 11px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--status-failed);
  transition: background var(--duration-normal) var(--ease-out);
}

.status-dot--connected {
  background: var(--status-completed);
  box-shadow: 0 0 8px rgba(92, 201, 137, 0.5);
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ─── SIDEBAR ─── */
.sidebar {
  background: var(--surface-1);
  border-right: 1px solid var(--surface-3);
  padding: var(--sp-5) var(--sp-4);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--sp-5);
}

.sidebar__section-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  margin-bottom: var(--sp-3);
}

.stat-card {
  background: var(--surface-2);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-m);
  padding: var(--sp-4);
  transition: border-color var(--duration-fast) var(--ease-out),
              background var(--duration-fast) var(--ease-out);
}

.stat-card:hover {
  border-color: var(--surface-4);
  background: var(--surface-3);
}

.stat-card__value {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -1px;
  line-height: 1;
  margin-bottom: var(--sp-1);
}

.stat-card__label {
  font-size: 11px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-card--total .stat-card__value { color: var(--text-primary); }
.stat-card--active .stat-card__value { color: var(--status-active); }
.stat-card--completed .stat-card__value { color: var(--status-completed); }
.stat-card--failed .stat-card__value { color: var(--status-failed); }
.stat-card--awaiting .stat-card__value { color: var(--status-awaiting); }

.sidebar__config {
  margin-top: auto;
  padding-top: var(--sp-4);
  border-top: 1px solid var(--surface-3);
}

.config-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--sp-1) 0;
  font-size: 11px;
}

.config-row__key {
  color: var(--text-muted);
}

.config-row__val {
  color: var(--text-secondary);
  text-align: right;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ─── MAIN AREA ─── */
.main {
  overflow-y: auto;
  padding: var(--sp-5);
  background: var(--surface-0);
}

.main__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--sp-5);
}

.main__title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-muted);
}

.main__updated {
  font-size: 11px;
  color: var(--text-muted);
}

/* ─── TASK TABLE ─── */
.task-table {
  width: 100%;
  border-collapse: collapse;
}

.task-table th {
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  padding: var(--sp-2) var(--sp-3);
  border-bottom: 1px solid var(--surface-3);
  font-weight: 500;
  position: sticky;
  top: 0;
  background: var(--surface-0);
  z-index: 2;
}

.task-row {
  cursor: pointer;
  transition: background var(--duration-fast) var(--ease-out);
}

.task-row:hover {
  background: var(--surface-2);
}

.task-row--expanded {
  background: var(--surface-1);
}

.task-row td {
  padding: var(--sp-3);
  border-bottom: 1px solid var(--surface-2);
  font-size: 12px;
  vertical-align: middle;
}

.task-row__id {
  color: var(--text-muted);
  font-size: 11px;
  font-family: inherit;
}

.task-row__title {
  color: var(--text-primary);
  font-weight: 500;
  max-width: 320px;
}

.task-row__title-main {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.task-row__repo {
  margin-top: 2px;
  font-size: 10px;
  color: var(--text-muted);
  text-transform: lowercase;
}

.task-row__branch {
  color: var(--text-secondary);
  font-size: 11px;
}

.task-row__time {
  color: var(--text-muted);
  font-size: 11px;
  white-space: nowrap;
}

.btn-retry {
  background: none;
  border: 1px solid var(--surface-4);
  color: var(--accent);
  font-size: 16px;
  width: 28px;
  height: 28px;
  border-radius: var(--radius-s);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all var(--duration-fast) var(--ease-out);
}
.btn-retry:hover {
  background: var(--accent);
  color: var(--text-inverse);
  border-color: var(--accent);
}
.btn-stop {
  background: none;
  border: 1px solid var(--surface-4);
  color: var(--red);
  font-size: 12px;
  width: 28px;
  height: 28px;
  border-radius: var(--radius-s);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all var(--duration-fast) var(--ease-out);
}
.btn-stop:hover {
  background: var(--red);
  color: var(--text-inverse);
  border-color: var(--red);
}

/* ─── STATUS BADGE ─── */
.badge {
  display: inline-flex;
  align-items: center;
  gap: var(--sp-1);
  padding: 2px 10px;
  border-radius: 100px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  white-space: nowrap;
  transition: transform var(--duration-fast) var(--ease-out),
              box-shadow var(--duration-fast) var(--ease-out);
}

.badge::before {
  content: "";
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.badge--queued    { background: rgba(94,90,87,0.2);   color: #9b9592; }
.badge--queued::before { background: var(--status-queued); }

.badge--planning,
.badge--coding,
.badge--committing,
.badge--approval  { background: rgba(91,158,233,0.15); color: #7db4f0; }
.badge--planning::before,
.badge--coding::before,
.badge--committing::before,
.badge--approval::before { background: var(--status-active); }

.badge--deploying { background: rgba(226,200,75,0.15); color: #e2c84b; }
.badge--deploying::before { background: var(--status-deploying); }

.badge--testing,
.badge--reporting { background: rgba(224,150,64,0.15); color: #e09640; }
.badge--testing::before,
.badge--reporting::before { background: var(--status-testing); }

.badge--completed { background: rgba(92,201,137,0.15); color: #5cc989; }
.badge--completed::before { background: var(--status-completed); }

.badge--failed    { background: rgba(224,92,92,0.15);  color: #e05c5c; }
.badge--failed::before { background: var(--status-failed); }

.badge--rollback  { background: rgba(176,124,224,0.15); color: #b07ce0; }
.badge--rollback::before { background: var(--status-rollback); }

.badge--awaiting_approval {
  background: rgba(232, 164, 74, 0.18);
  color: var(--accent);
  box-shadow: 0 0 12px rgba(232, 164, 74, 0.15), inset 0 0 0 1px rgba(232, 164, 74, 0.2);
  animation: awaiting-glow 2s ease-in-out infinite;
}
.badge--awaiting_approval::before {
  background: var(--status-awaiting);
  animation: pulse-badge 1.5s ease-in-out infinite;
}

@keyframes awaiting-glow {
  0%, 100% { box-shadow: 0 0 12px rgba(232, 164, 74, 0.15), inset 0 0 0 1px rgba(232, 164, 74, 0.2); }
  50% { box-shadow: 0 0 20px rgba(232, 164, 74, 0.3), inset 0 0 0 1px rgba(232, 164, 74, 0.35); }
}

/* Active phase animation */
.badge--planning::before,
.badge--coding::before,
.badge--committing::before,
.badge--deploying::before,
.badge--testing::before,
.badge--reporting::before,
.badge--approval::before {
  animation: pulse-badge 1.5s ease-in-out infinite;
}

@keyframes pulse-badge {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.75); }
}

/* ─── DETAIL PANEL ─── */
.detail-row {
  display: none;
}

.detail-row--open {
  display: table-row;
}

.detail-row td {
  padding: 0;
  border-bottom: 1px solid var(--surface-3);
}

.detail-panel {
  background: var(--surface-1);
  border-left: 3px solid var(--accent);
  padding: var(--sp-5);
  animation: slideDown var(--duration-normal) var(--ease-out);
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to   { opacity: 1; transform: translateY(0); }
}

.detail-panel__section {
  margin-bottom: var(--sp-5);
}

.detail-panel__section:last-child {
  margin-bottom: 0;
}

.detail-panel__heading {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--accent);
  margin-bottom: var(--sp-3);
  display: flex;
  align-items: center;
  gap: var(--sp-2);
}

.detail-panel__heading::before {
  content: "";
  display: block;
  width: 12px;
  height: 1px;
  background: var(--accent-dim);
}

/* ─── PIPELINE VISUALIZATION ─── */
.pipeline {
  display: flex;
  align-items: flex-start;
  gap: 0;
  padding: var(--sp-3) 0;
  overflow-x: auto;
}

.pipeline__step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  flex: 1;
  min-width: 80px;
  cursor: default;
}

.pipeline__step--clickable {
  cursor: pointer;
}

.pipeline__step--clickable:hover .pipeline__node {
  transform: scale(1.15);
}

.pipeline__connector {
  position: absolute;
  top: 14px;
  left: calc(50% + 16px);
  right: calc(-50% + 16px);
  height: 2px;
  background: var(--surface-4);
  z-index: 0;
}

.pipeline__connector--success {
  background: var(--status-completed);
  box-shadow: 0 0 6px rgba(92, 201, 137, 0.3);
}

.pipeline__connector--running {
  background: linear-gradient(90deg, var(--status-active), var(--surface-4));
  animation: connector-pulse 1.5s ease-in-out infinite;
}

@keyframes connector-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.pipeline__connector--failed {
  background: var(--status-failed);
  box-shadow: 0 0 6px rgba(224, 92, 92, 0.3);
}

.pipeline__node {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 11px;
  font-weight: 700;
  position: relative;
  z-index: 1;
  transition: transform var(--duration-fast) var(--ease-out),
              box-shadow var(--duration-fast) var(--ease-out);
  border: 2px solid var(--surface-4);
  background: var(--surface-2);
  color: var(--text-muted);
}

.pipeline__node--pending {
  border-color: var(--surface-4);
  background: var(--surface-2);
  color: var(--text-muted);
}

.pipeline__node--success {
  border-color: var(--status-completed);
  background: rgba(92, 201, 137, 0.15);
  color: var(--status-completed);
  box-shadow: 0 0 10px rgba(92, 201, 137, 0.2);
}

.pipeline__node--failed {
  border-color: var(--status-failed);
  background: rgba(224, 92, 92, 0.15);
  color: var(--status-failed);
  box-shadow: 0 0 10px rgba(224, 92, 92, 0.2);
}

.pipeline__node--running {
  border-color: var(--status-active);
  background: rgba(91, 158, 233, 0.15);
  color: var(--status-active);
  box-shadow: 0 0 12px rgba(91, 158, 233, 0.3);
  animation: node-running 2s ease-in-out infinite;
}

@keyframes node-running {
  0%, 100% { box-shadow: 0 0 12px rgba(91, 158, 233, 0.3); }
  50% { box-shadow: 0 0 22px rgba(91, 158, 233, 0.5); }
}

.pipeline__node--skipped {
  border-color: var(--surface-4);
  background: var(--surface-2);
  color: var(--text-muted);
  opacity: 0.4;
}

.pipeline__node--awaiting {
  border-color: var(--status-awaiting);
  background: rgba(232, 164, 74, 0.15);
  color: var(--status-awaiting);
  box-shadow: 0 0 12px rgba(232, 164, 74, 0.25);
  animation: node-awaiting 2s ease-in-out infinite;
}

@keyframes node-awaiting {
  0%, 100% { box-shadow: 0 0 12px rgba(232, 164, 74, 0.25); }
  50% { box-shadow: 0 0 22px rgba(232, 164, 74, 0.45); }
}

.pipeline__icon {
  font-size: 12px;
  line-height: 1;
}

.pipeline__label {
  margin-top: var(--sp-1);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  white-space: nowrap;
}

.pipeline__step--success .pipeline__label { color: var(--status-completed); }
.pipeline__step--failed .pipeline__label { color: var(--status-failed); }
.pipeline__step--running .pipeline__label { color: var(--status-active); }
.pipeline__step--awaiting .pipeline__label { color: var(--status-awaiting); }

.pipeline__timing {
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 1px;
}

.pipeline__error {
  margin-top: var(--sp-1);
  font-size: 10px;
  color: var(--status-failed);
  max-width: 120px;
  text-align: center;
  line-height: 1.3;
  word-break: break-word;
}

/* Pipeline step output expandable */
.pipeline-output {
  margin-top: var(--sp-3);
  background: var(--surface-0);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-s);
  overflow: hidden;
  animation: slideDown var(--duration-fast) var(--ease-out);
}

.pipeline-output__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--sp-2) var(--sp-3);
  font-size: 10px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  background: var(--surface-2);
  border-bottom: 1px solid var(--surface-3);
}

.pipeline-output__close {
  cursor: pointer;
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1;
  padding: 2px 6px;
  border-radius: var(--radius-s);
  border: none;
  background: none;
  font-family: inherit;
  transition: color var(--duration-fast) var(--ease-out), background var(--duration-fast) var(--ease-out);
}

.pipeline-output__close:hover {
  color: var(--text-primary);
  background: var(--surface-3);
}

.pipeline-output__pre {
  padding: var(--sp-3);
  font-size: 11px;
  line-height: 1.6;
  color: var(--text-secondary);
  overflow-x: auto;
  max-height: 250px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
  margin: 0;
  font-family: inherit;
}

.pipeline-output__pre--error {
  color: var(--status-failed);
}

/* ─── PROPOSALS SECTION ─── */
.proposal-card {
  background: var(--surface-2);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-m);
  margin-bottom: var(--sp-3);
  overflow: hidden;
}

.proposal-card__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--sp-3) var(--sp-4);
  gap: var(--sp-3);
}

.proposal-card__title-row {
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  flex: 1;
  min-width: 0;
}

.proposal-card__type {
  display: inline-flex;
  padding: 2px 8px;
  border-radius: var(--radius-s);
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  white-space: nowrap;
  background: rgba(91, 158, 233, 0.12);
  color: #7db4f0;
  border: 1px solid rgba(91, 158, 233, 0.2);
}

.proposal-card__type--deploy_fix { background: rgba(226,200,75,0.12); color: #e2c84b; border-color: rgba(226,200,75,0.2); }
.proposal-card__type--test_fix { background: rgba(224,150,64,0.12); color: #e09640; border-color: rgba(224,150,64,0.2); }
.proposal-card__type--infra_fix { background: rgba(176,124,224,0.12); color: #b07ce0; border-color: rgba(176,124,224,0.2); }

.proposal-card__summary {
  font-size: 12px;
  color: var(--text-primary);
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.proposal-card__status {
  display: inline-flex;
  padding: 2px 8px;
  border-radius: 100px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  white-space: nowrap;
}

.proposal-card__status--pending {
  background: rgba(232, 164, 74, 0.15);
  color: var(--accent);
}

.proposal-card__status--approved {
  background: rgba(92, 201, 137, 0.15);
  color: var(--status-completed);
}

.proposal-card__status--rejected {
  background: rgba(224, 92, 92, 0.15);
  color: var(--status-failed);
}

.proposal-card__body {
  padding: 0 var(--sp-4) var(--sp-4);
}

.proposal-card__reason {
  font-size: 11px;
  color: var(--text-secondary);
  margin-bottom: var(--sp-3);
  line-height: 1.5;
  padding: var(--sp-2) var(--sp-3);
  background: var(--surface-0);
  border-radius: var(--radius-s);
  border-left: 2px solid var(--surface-4);
}

/* ─── DIFF VIEWER ─── */
.diff-file {
  margin-bottom: var(--sp-3);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-s);
  overflow: hidden;
}

.diff-file:last-child {
  margin-bottom: 0;
}

.diff-file__header {
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  padding: var(--sp-2) var(--sp-3);
  background: var(--surface-3);
  font-size: 11px;
  cursor: pointer;
  user-select: none;
}

.diff-file__header:hover {
  background: var(--surface-4);
}

.diff-file__path {
  color: var(--text-primary);
  font-weight: 500;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.diff-file__action {
  display: inline-flex;
  padding: 1px 6px;
  border-radius: var(--radius-s);
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.diff-file__action--create { background: rgba(92,201,137,0.15); color: var(--status-completed); }
.diff-file__action--modify { background: rgba(91,158,233,0.15); color: #7db4f0; }
.diff-file__action--delete { background: rgba(224,92,92,0.15); color: var(--status-failed); }

.diff-file__chevron {
  color: var(--text-muted);
  font-size: 10px;
  transition: transform var(--duration-fast) var(--ease-out);
}

.diff-file__chevron--open {
  transform: rotate(90deg);
}

.diff-file__content {
  display: none;
}

.diff-file__content--open {
  display: block;
}

.diff-view {
  display: grid;
  grid-template-columns: 1fr 1fr;
  font-size: 11px;
  line-height: 1.6;
}

.diff-view__col {
  overflow-x: auto;
  min-width: 0;
}

.diff-view__label {
  padding: var(--sp-1) var(--sp-3);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  border-bottom: 1px solid var(--surface-3);
}

.diff-view__label--before {
  background: rgba(224, 92, 92, 0.06);
  color: var(--status-failed);
  border-right: 1px solid var(--surface-3);
}

.diff-view__label--after {
  background: rgba(92, 201, 137, 0.06);
  color: var(--status-completed);
}

.diff-view__code {
  padding: var(--sp-2) var(--sp-3);
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 300px;
  overflow-y: auto;
  tab-size: 2;
  font-family: inherit;
}

.diff-view__code--before {
  background: rgba(224, 92, 92, 0.04);
  color: var(--text-secondary);
  border-right: 1px solid var(--surface-3);
}

.diff-view__code--after {
  background: rgba(92, 201, 137, 0.04);
  color: var(--text-secondary);
}

.diff-view__code--empty {
  color: var(--text-muted);
  font-style: italic;
}

/* ─── APPROVE / REJECT BUTTONS ─── */
.proposal-actions {
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  margin-top: var(--sp-3);
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--sp-2);
  padding: var(--sp-2) var(--sp-4);
  border-radius: var(--radius-s);
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all var(--duration-fast) var(--ease-out);
  min-width: 100px;
  height: 32px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn--approve {
  background: rgba(92, 201, 137, 0.15);
  color: var(--status-completed);
  border-color: rgba(92, 201, 137, 0.3);
}

.btn--approve:hover:not(:disabled) {
  background: rgba(92, 201, 137, 0.25);
  box-shadow: 0 0 16px rgba(92, 201, 137, 0.2);
}

.btn--reject {
  background: transparent;
  color: var(--status-failed);
  border-color: rgba(224, 92, 92, 0.3);
}

.btn--reject:hover:not(:disabled) {
  background: rgba(224, 92, 92, 0.1);
  box-shadow: 0 0 16px rgba(224, 92, 92, 0.15);
}

.btn__spinner {
  display: inline-block;
  width: 12px;
  height: 12px;
  border: 2px solid currentColor;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.proposal-actions__msg {
  font-size: 11px;
  margin-left: var(--sp-2);
}

.proposal-actions__msg--ok {
  color: var(--status-completed);
}

.proposal-actions__msg--err {
  color: var(--status-failed);
}

/* ─── ATTEMPTS TIMELINE ─── */
.timeline {
  display: flex;
  flex-direction: column;
  gap: var(--sp-2);
  position: relative;
  padding-left: var(--sp-5);
}

.timeline::before {
  content: "";
  position: absolute;
  left: 8px;
  top: 4px;
  bottom: 4px;
  width: 1px;
  background: var(--surface-4);
}

.timeline__item {
  display: flex;
  align-items: flex-start;
  gap: var(--sp-3);
  font-size: 12px;
  position: relative;
}

.timeline__dot {
  position: absolute;
  left: -21px;
  top: 5px;
  width: 9px;
  height: 9px;
  border-radius: 50%;
  border: 2px solid var(--surface-4);
  background: var(--surface-1);
  flex-shrink: 0;
  z-index: 1;
}

.timeline__dot--running { border-color: var(--status-active); background: var(--status-active); }
.timeline__dot--passed  { border-color: var(--status-completed); background: var(--status-completed); }
.timeline__dot--failed  { border-color: var(--status-failed); background: var(--status-failed); }

.timeline__num {
  color: var(--text-muted);
  font-size: 10px;
  min-width: 20px;
}

.timeline__body {
  flex: 1;
}

.timeline__meta {
  color: var(--text-muted);
  font-size: 11px;
}

/* ─── DEPLOY & TEST RESULTS ─── */
.result-card {
  background: var(--surface-2);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-m);
  padding: var(--sp-3) var(--sp-4);
  margin-bottom: var(--sp-2);
}

.result-card__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}

.result-card__name {
  font-weight: 500;
  font-size: 12px;
}

.result-card__meta {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
  font-size: 11px;
  color: var(--text-muted);
}

.result-card__chevron {
  transition: transform var(--duration-fast) var(--ease-out);
  color: var(--text-muted);
  font-size: 10px;
}

.result-card__chevron--open {
  transform: rotate(90deg);
}

.result-card__output {
  display: none;
  margin-top: var(--sp-3);
}

.result-card__output--open {
  display: block;
}

.result-card__pre {
  background: var(--surface-0);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-s);
  padding: var(--sp-3);
  font-size: 11px;
  line-height: 1.6;
  color: var(--text-secondary);
  overflow-x: auto;
  max-height: 300px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
}

/* PR link */
.pr-link {
  display: inline-flex;
  align-items: center;
  gap: var(--sp-2);
  color: var(--accent);
  text-decoration: none;
  font-size: 12px;
  padding: var(--sp-2) var(--sp-3);
  border: 1px solid var(--accent-dim);
  border-radius: var(--radius-s);
  transition: background var(--duration-fast) var(--ease-out);
}

.pr-link:hover {
  background: var(--accent-glow);
}

/* ─── EMPTY STATE ─── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--sp-8) var(--sp-5);
  color: var(--text-muted);
  text-align: center;
  gap: var(--sp-3);
}

.empty-state__icon {
  font-size: 48px;
  opacity: 0.3;
  line-height: 1;
}

.empty-state__text {
  font-size: 13px;
}

/* ─── LOADING SKELETON ─── */
.skeleton {
  background: linear-gradient(90deg, var(--surface-2) 25%, var(--surface-3) 50%, var(--surface-2) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: var(--radius-s);
  height: 14px;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ─── STAGGER ENTRANCE ─── */
.stagger-enter {
  opacity: 0;
  transform: translateY(6px);
  animation: fadeUp var(--duration-normal) var(--ease-out) forwards;
}

@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

/* ─── MODAL ─── */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 1000;
  animation: fadeIn var(--duration-normal) var(--ease-out);
}

.modal--open {
  display: flex;
  align-items: center;
  justify-content: center;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal__content {
  background: var(--surface-2);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-l);
  padding: var(--sp-6);
  max-width: 500px;
  width: 90%;
  animation: slideUp var(--duration-normal) var(--ease-out);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--sp-5);
}

.modal__title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: -0.3px;
}

.modal__close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color var(--duration-fast) var(--ease-out);
}

.modal__close:hover {
  color: var(--text-primary);
}

.form-select {
  width: 100%;
  padding: var(--sp-3);
  background: var(--surface-2);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-s);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 12px;
  transition: border-color var(--duration-fast) var(--ease-out), box-shadow var(--duration-fast) var(--ease-out);
}

.form-select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

.issue-input {
  font-size: 24px;
  font-weight: 700;
  letter-spacing: -0.4px;
  background: var(--surface-1);
}

.issue-preview {
  margin-top: var(--sp-2);
  font-size: 11px;
  color: var(--text-secondary);
  word-break: break-all;
}

.advanced-toggle {
  display: inline-flex;
  align-items: center;
  gap: var(--sp-2);
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  cursor: pointer;
  padding: 0;
}

.advanced-toggle:hover {
  color: var(--text-primary);
}

.advanced-panel {
  display: none;
  margin-top: var(--sp-3);
  padding: var(--sp-3);
  background: var(--surface-1);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-s);
}

.advanced-panel--open {
  display: block;
}

.form-group {
  margin-bottom: var(--sp-4);
}

.form-group:last-child {
  margin-bottom: 0;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--sp-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: var(--sp-3);
  background: var(--surface-0);
  border: 1px solid var(--surface-3);
  border-radius: var(--radius-s);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 12px;
  transition: border-color var(--duration-fast) var(--ease-out),
              box-shadow var(--duration-fast) var(--ease-out);
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

.form-textarea {
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}

.form-error {
  display: none;
  font-size: 11px;
  color: var(--status-failed);
  margin-top: var(--sp-1);
}

.form-error--show {
  display: block;
}

.modal__actions {
  display: flex;
  gap: var(--sp-3);
  margin-top: var(--sp-5);
}

.modal__btn {
  flex: 1;
  padding: var(--sp-3) var(--sp-4);
  border-radius: var(--radius-s);
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  cursor: pointer;
  border: none;
  transition: all var(--duration-fast) var(--ease-out);
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--sp-2);
}

.modal__btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.modal__btn--primary {
  background: var(--accent);
  color: var(--text-inverse);
}

.modal__btn--primary:hover:not(:disabled) {
  background: var(--accent-dim);
  box-shadow: 0 0 16px var(--accent-glow-strong);
}

.modal__btn--secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--surface-3);
}

.modal__btn--secondary:hover:not(:disabled) {
  background: var(--surface-3);
  color: var(--text-primary);
}

/* ─── RESPONSIVE ─── */
@media (max-width: 768px) {
  .app {
    grid-template-columns: 1fr;
  }
  .sidebar {
    display: none;
  }
  .main {
    padding: var(--sp-3);
  }
  .task-row__branch,
  .task-table th:nth-child(5) {
    display: none;
  }
  .task-row td:nth-child(5) {
    display: none;
  }
  .diff-view {
    grid-template-columns: 1fr;
  }
  .pipeline__step {
    min-width: 60px;
  }
}

/* ─── SCROLLBAR ─── */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: var(--surface-4);
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}
</style>
</head>
<body>

<div class="app" id="app">
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar__brand">
      <div class="topbar__logo">R</div>
      <span class="topbar__title">Rig Dashboard</span>
      <span class="topbar__project" id="project-name"></span>
    </div>
    <div class="topbar__status">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-label">Connecting</span>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="sidebar__section-label">Overview</div>
      <div style="display:flex;flex-direction:column;gap:var(--sp-2);">
        <div class="stat-card stat-card--total">
          <div class="stat-card__value" id="stat-total">-</div>
          <div class="stat-card__label">Total Tasks</div>
        </div>
        <div class="stat-card stat-card--active">
          <div class="stat-card__value" id="stat-active">-</div>
          <div class="stat-card__label">In Progress</div>
        </div>
        <div class="stat-card stat-card--awaiting">
          <div class="stat-card__value" id="stat-awaiting">-</div>
          <div class="stat-card__label">Awaiting Approval</div>
        </div>
        <div class="stat-card stat-card--completed">
          <div class="stat-card__value" id="stat-completed">-</div>
          <div class="stat-card__label">Completed</div>
        </div>
        <div class="stat-card stat-card--failed">
          <div class="stat-card__value" id="stat-failed">-</div>
          <div class="stat-card__label">Failed</div>
        </div>
      </div>
    </div>
    <div class="sidebar__config" id="config-info">
      <div class="sidebar__section-label">Configuration</div>
    </div>
    <div style="margin-top:auto;display:flex;flex-direction:column;gap:var(--sp-2);padding-top:var(--sp-4);border-top:1px solid var(--surface-4);">
      <button onclick="showPage('tasks')" id="nav-tasks" class="nav-btn nav-btn--active" style="background:var(--surface-3);color:var(--text-primary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:11px;font-weight:600;cursor:pointer;text-align:left;">Tasks</button>
      <button onclick="showPage('settings')" id="nav-settings" class="nav-btn" style="background:var(--surface-2);color:var(--text-secondary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:11px;font-weight:600;cursor:pointer;text-align:left;">Settings</button>
      <button onclick="showPage('agents')" id="nav-agents" class="nav-btn" style="background:var(--surface-2);color:var(--text-secondary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:11px;font-weight:600;cursor:pointer;text-align:left;">AGENTS.md</button>
    </div>
  </aside>

   <!-- Main -->
   <main class="main" id="main">
     <div class="main__header">
       <div class="main__title">Tasks</div>
       <div style="display:flex;align-items:center;gap:var(--sp-4);">
         <button class="btn btn--primary" onclick="openNewTaskModal()" style="background:var(--accent);color:var(--text-inverse);border:none;padding:var(--sp-2) var(--sp-4);border-radius:var(--radius-s);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;cursor:pointer;transition:all var(--duration-fast) var(--ease-out);">New Task</button>
         <div class="main__updated" id="last-updated"></div>
       </div>
     </div>
    <div id="task-container">
      <div class="empty-state">
        <div class="empty-state__icon">&gt;_</div>
        <div class="empty-state__text">Loading tasks...</div>
      </div>
     </div>
   </main>

   <!-- Settings Page -->
   <main class="main" id="page-settings" style="display:none;">
     <div class="main__header">
       <div class="main__title">Settings</div>
       <div><button onclick="saveAllSettings()" style="background:var(--accent);color:var(--text-inverse);border:none;padding:var(--sp-2) var(--sp-4);border-radius:var(--radius-s);font-size:11px;font-weight:600;cursor:pointer;">Save All</button></div>
     </div>
     <div id="settings-container" style="display:flex;flex-direction:column;gap:var(--sp-4);padding:var(--sp-4);max-width:720px;"></div>
     <div id="settings-status" style="padding:var(--sp-3) var(--sp-4);color:var(--status-completed);font-size:12px;display:none;"></div>
   </main>

   <!-- AGENTS.md Page -->
   <main class="main" id="page-agents" style="display:none;">
     <div class="main__header">
       <div class="main__title">AGENTS.md</div>
     </div>
     <div style="padding:var(--sp-4);max-width:720px;">
       <div style="margin-bottom:var(--sp-3);">
         <label style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.8px;">Project</label>
         <select id="agents-project" onchange="loadAgentsForProject()" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:13px;margin-top:var(--sp-1);"></select>
       </div>
       <div style="margin-bottom:var(--sp-3);">
         <label style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.8px;">Content</label>
         <textarea id="agents-content" rows="20" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--surface-4);padding:var(--sp-3);border-radius:var(--radius-s);font-family:inherit;font-size:13px;line-height:1.6;resize:vertical;margin-top:var(--sp-1);" placeholder="# AGENTS.md&#10;&#10;Project-specific instructions for AI..."></textarea>
       </div>
       <button onclick="saveAgents()" style="background:var(--accent);color:var(--text-inverse);border:none;padding:var(--sp-2) var(--sp-4);border-radius:var(--radius-s);font-size:11px;font-weight:600;cursor:pointer;">Save</button>
       <span id="agents-status" style="margin-left:var(--sp-3);color:var(--status-completed);font-size:12px;display:none;"></span>
     </div>
   </main>
 </div>

 <!-- Settings Save Modal -->
 <div class="modal" id="settings-modal">
   <div class="modal__content" style="max-width:400px;text-align:center;">
     <div id="settings-modal-icon" style="font-size:48px;margin-bottom:var(--sp-3);"></div>
     <h2 class="modal__title" id="settings-modal-title" style="margin-bottom:var(--sp-2);"></h2>
     <p id="settings-modal-msg" style="font-size:13px;color:var(--text-secondary);margin-bottom:var(--sp-4);"></p>
     <div class="modal__actions" style="justify-content:center;">
       <button class="modal__btn modal__btn--primary" onclick="closeSettingsModal()">OK</button>
     </div>
   </div>
 </div>

 <!-- New Task Modal -->
 <div class="modal" id="new-task-modal">
   <div class="modal__content">
      <div class="modal__header">
        <h2 class="modal__title">Create New Task</h2>
        <button class="modal__close" onclick="closeNewTaskModal()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">Project</label>
        <select class="form-select" id="task-project"></select>
        <div class="form-error" id="error-project"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Issue Number</label>
        <input type="number" min="1" class="form-input issue-input" id="issue-num" placeholder="123">
        <div class="issue-preview" id="issue-url-preview">github.com/-/issues/-</div>
        <div class="form-error" id="error-issue-num"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Title (optional)</label>
        <input type="text" class="form-input" id="issue-title" placeholder="Leave blank to use Issue #number">
      </div>

      <div class="form-group" style="margin-top:var(--sp-5);">
        <button class="advanced-toggle" type="button" onclick="toggleAdvancedMode()">Advanced: Enter Full URL</button>
        <div class="advanced-panel" id="advanced-panel">
          <div class="form-group">
            <label class="form-label">GitHub Issue URL</label>
            <input type="text" class="form-input" id="issue-url-advanced" placeholder="https://github.com/owner/repo/issues/123">
            <div class="form-error" id="error-issue-url"></div>
          </div>
          <div style="font-size:11px;color:var(--text-muted);">When URL is set, it overrides project + issue number.</div>
        </div>
      </div>

      <div class="modal__actions">
        <button class="modal__btn modal__btn--secondary" onclick="closeNewTaskModal()">Cancel</button>
       <button class="modal__btn modal__btn--primary" id="submit-btn" onclick="submitNewTask()">Create Task</button>
     </div>
   </div>
 </div>

 <script>
(function() {
  "use strict";

  // ── State ──
  var tasks = [];
  var expandedId = null;
  var sseConnected = false;
  var pollTimer = null;
  var evtSource = null;
  var expandedPipelineStep = null;
  var expandedDiffFiles = {};
  var projects = [];
  var projectsLoaded = false;
  var advancedMode = false;

  // ── Pipeline phase order ──
  var PIPELINE_PHASES = [
    "queued", "planning", "coding", "committing",
    "deploying", "awaiting_approval", "testing", "reporting", "completed"
  ];

  // SVG icons for pipeline nodes
  var ICON_CHECK = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2.5 6L5 8.5L9.5 3.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  var ICON_X = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 3L9 9M9 3L3 9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';
  var ICON_PLAY = '<svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><path d="M2 1L9 5L2 9Z"/></svg>';
  var ICON_SKIP = '<svg width="10" height="10" viewBox="0 0 10 10" fill="none"><path d="M2 5H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';
  var ICON_CLOCK = '<svg width="10" height="10" viewBox="0 0 10 10" fill="none"><circle cx="5" cy="5" r="4" stroke="currentColor" stroke-width="1.2"/><path d="M5 3V5.5L6.5 6.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>';

  // ── DOM refs ──
  var $container = document.getElementById("task-container");
  var $total = document.getElementById("stat-total");
  var $active = document.getElementById("stat-active");
  var $completed = document.getElementById("stat-completed");
  var $failed = document.getElementById("stat-failed");
  var $awaiting = document.getElementById("stat-awaiting");
  var $dot = document.getElementById("status-dot");
  var $statusLabel = document.getElementById("status-label");
  var $lastUpdated = document.getElementById("last-updated");
  var $projectName = document.getElementById("project-name");
  var $configInfo = document.getElementById("config-info");

  // ── Helpers ──
  var activePhases = {
    planning: true, coding: true, committing: true,
    approval: true, deploying: true, testing: true,
    reporting: true, awaiting_approval: true
  };

  function escapeHTML(str) {
    if (!str) return "";
    var div = document.createElement("div");
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  function formatDate(iso) {
    if (!iso) return "-";
    var d = new Date(iso);
    if (isNaN(d.getTime())) return "-";
    var pad = function(n) { return n < 10 ? "0" + n : n; };
    return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) +
           " " + pad(d.getHours()) + ":" + pad(d.getMinutes());
  }

  function formatDuration(start, end) {
    if (!start) return "-";
    var s = new Date(start);
    var e = end ? new Date(end) : new Date();
    var diff = Math.max(0, e - s);
    var secs = Math.floor(diff / 1000);
    if (secs < 60) return secs + "s";
    var mins = Math.floor(secs / 60);
    secs = secs % 60;
    if (mins < 60) return mins + "m " + secs + "s";
    var hours = Math.floor(mins / 60);
    mins = mins % 60;
    return hours + "h " + mins + "m";
  }

  function formatNanoDuration(ns) {
    if (!ns && ns !== 0) return "-";
    var ms = ns / 1000000;
    if (ms < 1000) return Math.round(ms) + "ms";
    var s = ms / 1000;
    if (s < 60) return s.toFixed(1) + "s";
    var m = Math.floor(s / 60);
    s = (s % 60).toFixed(0);
    return m + "m " + s + "s";
  }

  function shortRepoName(repo) {
    if (!repo) return "-";
    var idx = repo.lastIndexOf("/");
    if (idx === -1 || idx === repo.length - 1) return repo;
    return repo.slice(idx + 1);
  }

  function formatStepDuration(startIso, endIso) {
    if (!startIso) return "";
    var s = new Date(startIso);
    var e = endIso ? new Date(endIso) : new Date();
    var diff = Math.max(0, e - s);
    var secs = Math.floor(diff / 1000);
    if (secs < 60) return secs + "s";
    var mins = Math.floor(secs / 60);
    secs = secs % 60;
    return mins + "m " + secs + "s";
  }

  function setConnected(connected) {
    sseConnected = connected;
    if (connected) {
      $dot.className = "status-dot status-dot--connected";
      $statusLabel.textContent = "Live";
    } else {
      $dot.className = "status-dot";
      $statusLabel.textContent = "Reconnecting";
    }
  }

  // ── Stats ──
  function updateStats() {
    var total = tasks.length;
    var active = 0, completed = 0, failed = 0, awaiting = 0;
    for (var i = 0; i < tasks.length; i++) {
      var s = tasks[i].status;
      if (s === "completed") completed++;
      else if (s === "failed" || s === "rollback") failed++;
      else if (s === "awaiting_approval") awaiting++;
      else if (activePhases[s]) active++;
    }
    $total.textContent = total;
    $active.textContent = active;
    $completed.textContent = completed;
    $failed.textContent = failed;
    $awaiting.textContent = awaiting;
    $lastUpdated.textContent = "Updated " + new Date().toLocaleTimeString();
  }

  // ── Build pipeline phase map from task data ──
  function buildPipelineMap(task) {
    var pipeline = task.pipeline || [];
    var map = {};
    for (var i = 0; i < pipeline.length; i++) {
      map[pipeline[i].phase] = pipeline[i];
    }
    return map;
  }

  // ── Render pipeline bar ──
  function renderPipeline(task) {
    var map = buildPipelineMap(task);
    var html = '<div class="pipeline">';

    for (var i = 0; i < PIPELINE_PHASES.length; i++) {
      var phase = PIPELINE_PHASES[i];
      var step = map[phase];
      var status = step ? step.status : "pending";
      var nodeClass = "pipeline__node pipeline__node--" + status;
      var stepClass = "pipeline__step pipeline__step--" + status;
      var hasContent = step && (step.output || step.error);
      if (hasContent) {
        stepClass += " pipeline__step--clickable";
      }

      var icon;
      if (status === "success") icon = ICON_CHECK;
      else if (status === "failed") icon = ICON_X;
      else if (status === "running") icon = ICON_PLAY;
      else if (status === "skipped") icon = ICON_SKIP;
      else if (status === "awaiting") icon = ICON_CLOCK;
      else icon = ICON_CLOCK;

      var displayLabel = phase === "awaiting_approval" ? "approval" : phase;

      html += '<div class="' + stepClass + '"' +
        (hasContent ? ' onclick="togglePipelineOutput(\'' + escapeHTML(task.id) + '\', \'' + escapeHTML(phase) + '\', event)"' : '') +
        '>';

      if (i > 0) {
        var prevPhase = PIPELINE_PHASES[i - 1];
        var prevStep = map[prevPhase];
        var prevStatus = prevStep ? prevStep.status : "pending";
        var connClass = "pipeline__connector";
        if (prevStatus === "success") connClass += " pipeline__connector--success";
        else if (prevStatus === "running") connClass += " pipeline__connector--running";
        else if (prevStatus === "failed") connClass += " pipeline__connector--failed";
        html += '<div class="' + connClass + '"></div>';
      }

      html += '<div class="' + nodeClass + '"><span class="pipeline__icon">' + icon + '</span></div>';
      html += '<span class="pipeline__label">' + escapeHTML(displayLabel) + '</span>';

      if (step && step.started_at) {
        html += '<span class="pipeline__timing">' + formatStepDuration(step.started_at, step.ended_at) + '</span>';
      }

      if (step && step.error && status === "failed") {
        var shortErr = step.error.length > 60 ? step.error.substring(0, 60) + "..." : step.error;
        html += '<div class="pipeline__error">' + escapeHTML(shortErr) + '</div>';
      }

      html += '</div>';
    }

    html += '</div>';

    if (expandedPipelineStep && expandedPipelineStep.taskId === task.id) {
      var activeStep = map[expandedPipelineStep.phase];
      if (activeStep && (activeStep.output || activeStep.error)) {
        html += '<div class="pipeline-output">';
        html += '<div class="pipeline-output__header">';
        html += '<span>' + escapeHTML(expandedPipelineStep.phase) + (activeStep.error ? ' - Error' : ' - Output') + '</span>';
        html += '<button class="pipeline-output__close" onclick="closePipelineOutput(event)">x</button>';
        html += '</div>';
        if (activeStep.error) {
          html += '<pre class="pipeline-output__pre pipeline-output__pre--error">' + escapeHTML(activeStep.error) + '</pre>';
        }
        if (activeStep.output) {
          html += '<pre class="pipeline-output__pre">' + escapeHTML(activeStep.output) + '</pre>';
        }
        html += '</div>';
      }
    }

    return html;
  }

  // ── Toggle pipeline step output ──
  window.togglePipelineOutput = function(taskId, phase, e) {
    e.stopPropagation();
    if (expandedPipelineStep && expandedPipelineStep.taskId === taskId && expandedPipelineStep.phase === phase) {
      expandedPipelineStep = null;
    } else {
      expandedPipelineStep = { taskId: taskId, phase: phase };
    }
    renderTasks();
  };

  window.closePipelineOutput = function(e) {
    e.stopPropagation();
    expandedPipelineStep = null;
    renderTasks();
  };

  // ── Render proposals section ──
  function renderProposals(task) {
    var proposals = task.proposals || [];
    if (proposals.length === 0) return "";

    var html = '<div class="detail-panel__section">' +
      '<div class="detail-panel__heading">Proposals (' + proposals.length + ')</div>';

    for (var p = 0; p < proposals.length; p++) {
      var prop = proposals[p];
      var statusClass = "proposal-card__status--" + (prop.status || "pending");
      var typeClass = "proposal-card__type--" + (prop.type || "").replace(/ /g, "_");

      html += '<div class="proposal-card">';
      html += '<div class="proposal-card__header">';
      html += '<div class="proposal-card__title-row">';
      if (prop.type) {
        html += '<span class="proposal-card__type ' + typeClass + '">' + escapeHTML(prop.type) + '</span>';
      }
      html += '<span class="proposal-card__summary">' + escapeHTML(prop.summary || "Proposal #" + (p + 1)) + '</span>';
      html += '</div>';
      html += '<span class="proposal-card__status ' + statusClass + '">' + escapeHTML(prop.status || "pending") + '</span>';
      html += '</div>';

      html += '<div class="proposal-card__body">';

      if (prop.reason) {
        html += '<div class="proposal-card__reason">' + escapeHTML(prop.reason) + '</div>';
      }

      var changes = prop.changes || [];
      if (changes.length > 0) {
        html += '<div style="margin-bottom:var(--sp-2);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);">Changes (' + changes.length + ' file' + (changes.length !== 1 ? 's' : '') + ')</div>';
        for (var c = 0; c < changes.length; c++) {
          html += renderDiffFile(task.id, p, c, changes[c]);
        }
      }

      if (!prop.status || prop.status === "pending") {
        html += '<div class="proposal-actions" id="proposal-actions-' + escapeHTML(task.id) + '-' + p + '">';
        html += '<button class="btn btn--approve" onclick="approveTask(\'' + escapeHTML(task.id) + '\', ' + p + ', event)">Approve</button>';
        html += '<button class="btn btn--reject" onclick="rejectTask(\'' + escapeHTML(task.id) + '\', ' + p + ', event)">Reject</button>';
        html += '</div>';
      }

      html += '</div>';
      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  // ── Render diff file ──
  function renderDiffFile(taskId, proposalIdx, changeIdx, change) {
    var diffKey = taskId + "-" + proposalIdx + "-" + changeIdx;
    var isOpen = expandedDiffFiles[diffKey] || false;
    var action = change.action || "modify";
    var actionClass = "diff-file__action--" + action;

    var html = '<div class="diff-file">';
    html += '<div class="diff-file__header" onclick="toggleDiffFile(\'' + diffKey + '\', event)">';
    html += '<span class="diff-file__action ' + actionClass + '">' + escapeHTML(action) + '</span>';
    html += '<span class="diff-file__path">' + escapeHTML(change.path || change.file || "unknown") + '</span>';
    html += '<span class="diff-file__chevron' + (isOpen ? ' diff-file__chevron--open' : '') + '">&#9654;</span>';
    html += '</div>';

    html += '<div class="diff-file__content' + (isOpen ? ' diff-file__content--open' : '') + '">';
    html += '<div class="diff-view">';

    html += '<div class="diff-view__col">';
    html += '<div class="diff-view__label diff-view__label--before">Before</div>';
    var beforeContent = change.before || change.original || "";
    if (beforeContent) {
      html += '<pre class="diff-view__code diff-view__code--before">' + escapeHTML(beforeContent) + '</pre>';
    } else {
      html += '<pre class="diff-view__code diff-view__code--before diff-view__code--empty">(empty)</pre>';
    }
    html += '</div>';

    html += '<div class="diff-view__col">';
    html += '<div class="diff-view__label diff-view__label--after">After</div>';
    var afterContent = change.after || change.proposed || "";
    if (afterContent) {
      html += '<pre class="diff-view__code diff-view__code--after">' + escapeHTML(afterContent) + '</pre>';
    } else {
      html += '<pre class="diff-view__code diff-view__code--after diff-view__code--empty">(empty)</pre>';
    }
    html += '</div>';

    html += '</div>';
    html += '</div>';
    html += '</div>';

    return html;
  }

  // ── Toggle diff file ──
  window.toggleDiffFile = function(key, e) {
    e.stopPropagation();
    expandedDiffFiles[key] = !expandedDiffFiles[key];
    renderTasks();
  };

  // ── Approve / Reject API ──
  window.approveTask = function(taskId, proposalIdx, e) {
    e.stopPropagation();
    var container = document.getElementById("proposal-actions-" + taskId + "-" + proposalIdx);
    if (!container) return;
    setActionLoading(container, "approve");

    fetch("/api/approve/" + encodeURIComponent(taskId), { method: "POST" })
      .then(function(r) {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(function(data) {
        setActionMessage(container, data.message || "Approved", true);
        fetchTasks();
      })
      .catch(function(err) {
        setActionMessage(container, err.message || "Failed", false);
        setActionButtons(container, taskId, proposalIdx);
      });
  };

  window.rejectTask = function(taskId, proposalIdx, e) {
    e.stopPropagation();
    var container = document.getElementById("proposal-actions-" + taskId + "-" + proposalIdx);
    if (!container) return;
    setActionLoading(container, "reject");

    fetch("/api/reject/" + encodeURIComponent(taskId), { method: "POST" })
      .then(function(r) {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(function(data) {
        setActionMessage(container, data.message || "Rejected", true);
        fetchTasks();
      })
      .catch(function(err) {
        setActionMessage(container, err.message || "Failed", false);
        setActionButtons(container, taskId, proposalIdx);
      });
  };

  function setActionLoading(container, type) {
    var approveBtn = container.querySelector(".btn--approve");
    var rejectBtn = container.querySelector(".btn--reject");
    if (approveBtn) approveBtn.disabled = true;
    if (rejectBtn) rejectBtn.disabled = true;
    var targetBtn = type === "approve" ? approveBtn : rejectBtn;
    if (targetBtn) {
      targetBtn.innerHTML = '<span class="btn__spinner"></span> ' + (type === "approve" ? "Approving" : "Rejecting");
    }
  }

  function setActionMessage(container, msg, isOk) {
    var existingMsg = container.querySelector(".proposal-actions__msg");
    if (existingMsg) existingMsg.remove();
    var span = document.createElement("span");
    span.className = "proposal-actions__msg " + (isOk ? "proposal-actions__msg--ok" : "proposal-actions__msg--err");
    span.textContent = msg;
    container.appendChild(span);
  }

  function setActionButtons(container, taskId, proposalIdx) {
    setTimeout(function() {
      var approveBtn = container.querySelector(".btn--approve");
      var rejectBtn = container.querySelector(".btn--reject");
      if (approveBtn) { approveBtn.disabled = false; approveBtn.innerHTML = "Approve"; }
      if (rejectBtn) { rejectBtn.disabled = false; rejectBtn.innerHTML = "Reject"; }
    }, 2000);
  }

  // ── Render tasks ──
  function renderTasks() {
    if (tasks.length === 0) {
      $container.innerHTML =
        '<div class="empty-state">' +
          '<div class="empty-state__icon">&gt;_</div>' +
          '<div class="empty-state__text">No tasks found. Waiting for issues...</div>' +
        '</div>';
      updateStats();
      return;
    }

    // Sort: active first, then by created_at desc
    var sorted = tasks.slice().sort(function(a, b) {
      var aActive = activePhases[a.status] ? 0 : 1;
      var bActive = activePhases[b.status] ? 0 : 1;
      if (aActive !== bActive) return aActive - bActive;
      return new Date(b.created_at) - new Date(a.created_at);
    });

    var html = '<table class="task-table"><thead><tr>' +
      '<th>ID</th><th>Issue</th><th>Status</th><th>Branch</th><th>Created</th><th>Duration</th><th></th>' +
      '</tr></thead><tbody>';

    for (var i = 0; i < sorted.length; i++) {
      var t = sorted[i];
      var isExpanded = expandedId === t.id;
      var delay = Math.min(i * 30, 300);
      var issueTitle = t.issue ? t.issue.title : "-";
      var issueRepo = t.issue ? t.issue.repo : "";
      var repoLabel = shortRepoName(issueRepo);

      html += '<tr class="task-row stagger-enter' + (isExpanded ? ' task-row--expanded' : '') +
              '" data-id="' + escapeHTML(t.id) + '" style="animation-delay:' + delay + 'ms">' +
        '<td class="task-row__id">' + escapeHTML(t.id) + '</td>' +
        '<td class="task-row__title"><div class="task-row__title-main">' + escapeHTML(issueTitle) + '</div><div class="task-row__repo">' + escapeHTML(repoLabel) + '</div></td>' +
        '<td><span class="badge badge--' + escapeHTML(t.status) + '">' + escapeHTML(t.status) + '</span></td>' +
        '<td class="task-row__branch">' + escapeHTML(t.branch || "-") + '</td>' +
        '<td class="task-row__time">' + formatDate(t.created_at) + '</td>' +
        '<td class="task-row__time">' + formatDuration(t.created_at, t.completed_at) + '</td>' +
        '<td class="task-row__actions">' +
          (function() {
            var running = (t.status === "coding" || t.status === "deploying" || t.status === "testing" || t.status === "planning" || t.status === "committing" || t.status === "reporting");
            if (running) {
              return '<button class="btn-stop" onclick="event.stopPropagation(); stopTask(\'' + escapeHTML(t.id) + '\')" title="Stop">&#x25a0;</button>';
            } else {
              return '<button class="btn-retry" onclick="event.stopPropagation(); retryTask(\'' + escapeHTML(t.id) + '\')" title="Run">&#x25b6;</button>';
            }
          })() +
        '</td>' +
      '</tr>';

      // Detail row
      html += '<tr class="detail-row' + (isExpanded ? ' detail-row--open' : '') + '" data-detail="' + escapeHTML(t.id) + '">' +
        '<td colspan="7">' + (isExpanded ? renderDetail(t) : '') + '</td></tr>';
    }

    html += '</tbody></table>';
    $container.innerHTML = html;

    // Bind click events
    var rows = $container.querySelectorAll(".task-row");
    for (var j = 0; j < rows.length; j++) {
      rows[j].addEventListener("click", onRowClick);
    }

    updateStats();
  }

  function onRowClick(e) {
    var id = e.currentTarget.getAttribute("data-id");
    if (expandedId === id) {
      expandedId = null;
    } else {
      expandedId = id;
    }
    if (!expandedId) {
      expandedPipelineStep = null;
    }
    renderTasks();
  }

  // ── Render detail panel ──
  function renderDetail(task) {
    var html = '<div class="detail-panel">';

    // Pipeline visualization (always at top)
    var pipeline = task.pipeline || [];
    if (pipeline.length > 0 || task.status) {
      html += '<div class="detail-panel__section">' +
        '<div class="detail-panel__heading">Pipeline</div>' +
        renderPipeline(task) +
        '</div>';
    }

    // PR link
    if (task.pr && task.pr.url) {
      html += '<div class="detail-panel__section">' +
        '<div class="detail-panel__heading">Pull Request</div>' +
        '<a class="pr-link" href="' + escapeHTML(task.pr.url) + '" target="_blank" rel="noopener">' +
          '&#8599; ' + escapeHTML(task.pr.url) +
        '</a></div>';
    }

    // Proposals
    html += renderProposals(task);

    // Logs
    html += '<div class="detail-panel__section">' +
      '<div class="detail-panel__heading">Logs</div>' +
      '<div class="task-logs" id="logs-' + escapeHTML(task.id) + '" style="background:var(--surface-1);border:1px solid var(--surface-4);border-radius:var(--radius-s);padding:var(--sp-3);max-height:300px;overflow-y:auto;font-family:var(--font-mono);font-size:11px;line-height:1.6;">' +
        '<div style="color:var(--text-muted);">Loading logs...</div>' +
      '</div></div>';

    // Load logs async
    setTimeout(function() { loadTaskLogs(task.id); }, 50);

    // Attempts
    var attempts = task.attempts || [];
    if (attempts.length > 0) {
      html += '<div class="detail-panel__section">' +
        '<div class="detail-panel__heading">Attempts (' + attempts.length + ')</div>' +
        '<div class="timeline">';
      for (var i = 0; i < attempts.length; i++) {
        var a = attempts[i];
        var dotClass = "timeline__dot";
        if (a.status === "running") dotClass += " timeline__dot--running";
        else if (a.status === "passed") dotClass += " timeline__dot--passed";
        else if (a.status === "failed") dotClass += " timeline__dot--failed";

        html += '<div class="timeline__item">' +
          '<div class="' + dotClass + '"></div>' +
          '<span class="timeline__num">#' + a.number + '</span>' +
          '<div class="timeline__body">' +
            '<span class="badge badge--' + (a.status === "passed" ? "completed" : a.status === "failed" ? "failed" : "coding") + '">' +
              escapeHTML(a.status) + '</span>';

        if (a.fail_reason) {
          html += ' <span style="color:var(--text-muted);font-size:11px;">' + escapeHTML(a.fail_reason) + '</span>';
        }

        html += '<div class="timeline__meta">' +
          formatDate(a.started_at);
        if (a.completed_at) {
          html += ' &mdash; ' + formatDuration(a.started_at, a.completed_at);
        }
        html += '</div>';

        // Files changed
        if (a.files_changed && a.files_changed.length > 0) {
          html += '<div class="timeline__meta" style="margin-top:2px">' +
            a.files_changed.length + ' file(s) changed</div>';
        }

        // Deploy result inside attempt
        if (a.deploy) {
          html += renderDeployResult(a.deploy);
        }

        // Tests inside attempt
        if (a.tests && a.tests.length > 0) {
          for (var j = 0; j < a.tests.length; j++) {
            html += renderTestResult(a.tests[j], i + "-" + j);
          }
        }

        html += '</div></div>';
      }
      html += '</div></div>';
    }

    html += '</div>';
    return html;
  }

  function renderDeployResult(deploy) {
    var uid = "deploy-" + Math.random().toString(36).substr(2, 6);
    return '<div class="result-card" style="margin-top:var(--sp-2)">' +
      '<div class="result-card__header" onclick="toggleOutput(\'' + uid + '\', event)">' +
        '<span class="result-card__name">' +
          '<span class="badge badge--' + (deploy.status === "success" ? "completed" : "failed") + '">' +
            escapeHTML(deploy.status) + '</span> Deploy' +
        '</span>' +
        '<span class="result-card__meta">' +
          formatNanoDuration(deploy.duration) +
          ' <span class="result-card__chevron" id="chev-' + uid + '">&#9654;</span>' +
        '</span>' +
      '</div>' +
      '<div class="result-card__output" id="out-' + uid + '">' +
        '<pre class="result-card__pre">' + escapeHTML(deploy.output || "No output") + '</pre>' +
      '</div>' +
    '</div>';
  }

  function renderTestResult(test, key) {
    var uid = "test-" + key + "-" + Math.random().toString(36).substr(2, 6);
    return '<div class="result-card" style="margin-top:var(--sp-2)">' +
      '<div class="result-card__header" onclick="toggleOutput(\'' + uid + '\', event)">' +
        '<span class="result-card__name">' +
          '<span class="badge badge--' + (test.passed ? "completed" : "failed") + '">' +
            (test.passed ? "pass" : "fail") + '</span> ' +
          escapeHTML(test.name || "Test") +
        '</span>' +
        '<span class="result-card__meta">' +
          (test.type ? '<span style="color:var(--text-muted)">' + escapeHTML(test.type) + '</span>' : '') +
          ' ' + formatNanoDuration(test.duration) +
          ' <span class="result-card__chevron" id="chev-' + uid + '">&#9654;</span>' +
        '</span>' +
      '</div>' +
      '<div class="result-card__output" id="out-' + uid + '">' +
        '<pre class="result-card__pre">' + escapeHTML(test.output || "No output") + '</pre>' +
      '</div>' +
    '</div>';
  }

  // Global toggle for output panels
  window.toggleOutput = function(uid, e) {
    e.stopPropagation();
    var out = document.getElementById("out-" + uid);
    var chev = document.getElementById("chev-" + uid);
    if (!out) return;
    var isOpen = out.classList.contains("result-card__output--open");
    if (isOpen) {
      out.classList.remove("result-card__output--open");
      if (chev) chev.classList.remove("result-card__chevron--open");
    } else {
      out.classList.add("result-card__output--open");
      if (chev) chev.classList.add("result-card__chevron--open");
    }
  };

  // ── Load config ──
  function loadConfig() {
    fetch("/api/config")
      .then(function(r) { return r.json(); })
      .then(function(cfg) {
        if (cfg.project && cfg.project.name) {
          $projectName.textContent = cfg.project.name;
        }
        var html = '<div class="sidebar__section-label">Configuration</div>';
        if (cfg.project) {
          html += configRow("Language", cfg.project.language || "-");
        }
        if (cfg.source) {
          html += configRow("Platform", cfg.source.platform || "-");
          html += configRow("Repo", cfg.source.repo || "-");
        }
        if (cfg.ai) {
          html += configRow("Provider", cfg.ai.provider || "-");
          html += configRow("Model", cfg.ai.model || "-");
          html += configRow("Retries", cfg.ai.max_retry || "-");
        }
        if (cfg.deploy) {
          html += configRow("Deploy", cfg.deploy.method || "-");
        }
        $configInfo.innerHTML = html;
      })
      .catch(function() { /* silently ignore */ });
  }

  function configRow(key, val) {
    return '<div class="config-row"><span class="config-row__key">' +
      escapeHTML(key) + '</span><span class="config-row__val">' +
      escapeHTML(String(val)) + '</span></div>';
  }

  // ── SSE ──
  function connectSSE() {
    if (evtSource) {
      evtSource.close();
    }

    evtSource = new EventSource("/api/events");

    evtSource.addEventListener("tasks", function(e) {
      try {
        var data = JSON.parse(e.data);
        tasks = data;
        renderTasks();
      } catch (err) {
        // ignore parse errors
      }
    });

    evtSource.onopen = function() {
      setConnected(true);
      stopPoll();
    };

    evtSource.onerror = function() {
      setConnected(false);
      evtSource.close();
      evtSource = null;
      startPoll();
      // Retry SSE after 5s
      setTimeout(connectSSE, 5000);
    };
  }

  // ── Fallback polling ──
  function fetchTasks() {
    fetch("/api/tasks")
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (Array.isArray(data)) {
          tasks = data;
          renderTasks();
        }
      })
      .catch(function() { /* ignore */ });
  }

  function startPoll() {
    if (pollTimer) return;
    pollTimer = setInterval(fetchTasks, 5000);
  }

  function stopPoll() {
    if (pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  // ── New Task Modal ──
  function renderProjectOptions() {
    var select = document.getElementById("task-project");
    if (!select) return;

    if (!projects || projects.length === 0) {
      select.innerHTML = '<option value="">No projects configured</option>';
      return;
    }

    var html = "";
    for (var i = 0; i < projects.length; i++) {
      var p = projects[i];
      var label = p.name ? p.name + " (" + p.repo + ")" : p.repo;
      html += '<option value="' + escapeHTML(p.repo) + '">' + escapeHTML(label) + '</option>';
    }
    select.innerHTML = html;
  }

  function loadProjects() {
    return fetch("/api/projects")
      .then(function(r) {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(function(data) {
        projects = Array.isArray(data) ? data : [];
        projectsLoaded = true;
        renderProjectOptions();
        updateIssuePreview();
      })
      .catch(function() {
        projects = [];
        projectsLoaded = true;
        renderProjectOptions();
      });
  }

  function updateIssuePreview() {
    var select = document.getElementById("task-project");
    var issueNum = document.getElementById("issue-num").value.trim();
    var preview = document.getElementById("issue-url-preview");
    var repo = select && select.value ? select.value : "-";
    var num = issueNum || "-";
    preview.textContent = "github.com/" + repo + "/issues/" + num;
  }

  window.openNewTaskModal = function() {
    var modal = document.getElementById("new-task-modal");
    modal.classList.add("modal--open");

    if (!projectsLoaded) {
      loadProjects().then(function() {
        document.getElementById("issue-num").focus();
      });
    } else {
      renderProjectOptions();
      updateIssuePreview();
      document.getElementById("issue-num").focus();
    }
  };

  window.closeNewTaskModal = function() {
    var modal = document.getElementById("new-task-modal");
    modal.classList.remove("modal--open");
    clearFormErrors();
    clearFormInputs();
    advancedMode = false;
    document.getElementById("advanced-panel").classList.remove("advanced-panel--open");
  };

  window.toggleAdvancedMode = function() {
    advancedMode = !advancedMode;
    var panel = document.getElementById("advanced-panel");
    if (advancedMode) {
      panel.classList.add("advanced-panel--open");
      document.getElementById("issue-url-advanced").focus();
    } else {
      panel.classList.remove("advanced-panel--open");
    }
  };

  function clearFormErrors() {
    var errors = document.querySelectorAll(".form-error");
    for (var i = 0; i < errors.length; i++) {
      errors[i].classList.remove("form-error--show");
      errors[i].textContent = "";
    }
  }

  function clearFormInputs() {
    document.getElementById("issue-num").value = "";
    document.getElementById("issue-title").value = "";
    document.getElementById("issue-url-advanced").value = "";
    updateIssuePreview();
  }

  function showError(fieldId, message) {
    var errorEl = document.getElementById("error-" + fieldId);
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.classList.add("form-error--show");
    }
  }

  window.submitNewTask = function() {
    clearFormErrors();
    var submitBtn = document.getElementById("submit-btn");
    var hasError = false;

    var payload = {};

    var selectedProject = document.getElementById("task-project").value;
    var issueNum = document.getElementById("issue-num").value.trim();
    var issueURL = document.getElementById("issue-url-advanced").value.trim();
    var title = document.getElementById("issue-title").value.trim();

    if (issueURL) {
      payload.issue_url = issueURL;
    } else {
      if (!selectedProject) {
        showError("project", "Project is required");
        hasError = true;
      } else {
        payload.project = selectedProject;
      }
      if (!issueNum) {
        showError("issue-num", "Issue number is required");
        hasError = true;
      } else {
        payload.issue_num = issueNum;
      }
    }

    if (title) {
      payload.title = title;
    }

    if (hasError) return;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="btn__spinner"></span> Creating...';

    fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(function(r) {
        if (!r.ok) {
          return r.json().then(function(data) {
            throw new Error(data.error || "HTTP " + r.status);
          });
        }
        return r.json();
      })
      .then(function(task) {
        closeNewTaskModal();
        fetchTasks();
      })
      .catch(function(err) {
        if (issueURL) {
          showError("issue-url", err.message || "Failed to create task");
        } else {
          showError("issue-num", err.message || "Failed to create task");
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = "Create Task";
      });
  };

  // Close modal on background click
  document.getElementById("new-task-modal").addEventListener("click", function(e) {
    if (e.target === this) {
      closeNewTaskModal();
    }
  });

  document.getElementById("task-project").addEventListener("change", updateIssuePreview);
  document.getElementById("issue-num").addEventListener("input", updateIssuePreview);

  // ── Page navigation ──
  var currentPage = "tasks";

  window.showPage = function(page) {
    currentPage = page;
    var mainEl = document.getElementById("main");
    var settingsEl = document.getElementById("page-settings");
    var agentsEl = document.getElementById("page-agents");

    mainEl.style.display = page === "tasks" ? "" : "none";
    settingsEl.style.display = page === "settings" ? "" : "none";
    agentsEl.style.display = page === "agents" ? "" : "none";

    // Update nav button styles
    var btns = document.querySelectorAll(".nav-btn");
    for (var i = 0; i < btns.length; i++) {
      btns[i].style.background = "var(--surface-2)";
      btns[i].style.color = "var(--text-secondary)";
    }
    var activeBtn = document.getElementById("nav-" + page);
    if (activeBtn) {
      activeBtn.style.background = "var(--surface-3)";
      activeBtn.style.color = "var(--text-primary)";
    }

    if (page === "settings") loadSettings();
    if (page === "agents") loadAgentsPage();
  };

  // ── Settings ──
  var SETTINGS_SECTIONS = [
    { key: "project", label: "Project", fields: [
      { name: "name", label: "Name", type: "text" },
      { name: "description", label: "Description", type: "text" }
    ]},
    { key: "source", label: "Repository", fields: [
      { name: "repo", label: "Repo", type: "text", placeholder: "https://github.com/popododo0720/test_repo.git" },
      { name: "base_branch", label: "Base Branch", type: "text", placeholder: "main" },
      { name: "token", label: "Token", type: "password" }
    ]},
    { key: "ai", label: "AI Provider", fields: [
      { name: "provider", label: "Provider", type: "select", options: ["claude-code", "anthropic", "openai", "ollama"] },
      { name: "model", label: "Model", type: "text", placeholder: "claude-opus-4-6" },
      { name: "api_key", label: "API Key", type: "password", placeholder: "not needed for claude-code" },
      { name: "max_retry", label: "Max Retry (0=unlimited)", type: "number" }
    ]},
    { key: "deploy", label: "Deploy", fields: [
      { name: "method", label: "Method", type: "select", options: ["none", "custom", "docker-compose", "k8s", "terraform", "ansible"] },
      { name: "commands", label: "Commands (one per line)", type: "textarea", placeholder: "go build -o app ./cmd/...\n./deploy.sh" },
      { name: "infra_files", label: "Infra Files (comma-separated)", type: "text", placeholder: "docker-compose.yml, Dockerfile" }
    ]},
    { key: "test", label: "Test", fields: [
      { name: "name", label: "Name", type: "text", placeholder: "Unit Tests" },
      { name: "type", label: "Type", type: "select", options: ["command", "ai-verify"] },
      { name: "run", label: "Command", type: "text", placeholder: "go test ./..." }
    ]},
    { key: "server", label: "Server", fields: [
      { name: "port", label: "Webhook Port", type: "number", placeholder: "8080" },
      { name: "secret", label: "Webhook Secret", type: "password" }
    ]}
  ];

  var settingsData = {};

  // Flatten nested deploy/test config into simple field values for forms.
  function flattenSettingsSection(key, raw) {
    if (!raw) return {};
    if (key === "deploy") {
      var flat = { method: raw.method || "none" };
      // Extract commands from config.commands array into newline-separated text.
      if (raw.config && raw.config.commands && raw.config.commands.length > 0) {
        var lines = [];
        for (var i = 0; i < raw.config.commands.length; i++) {
          lines.push(raw.config.commands[i].run || "");
        }
        flat.commands = lines.join("\n");
      } else {
        flat.commands = "";
      }
      // Flatten infra_files array to comma-separated string.
      if (raw.infra_files && raw.infra_files.length > 0) {
        flat.infra_files = raw.infra_files.join(", ");
      } else {
        flat.infra_files = "";
      }
      return flat;
    }
    if (key === "test") {
      // Test is stored as an array; show the first entry in the form.
      if (Array.isArray(raw) && raw.length > 0) {
        return { name: raw[0].name || "", type: raw[0].type || "command", run: raw[0].run || "" };
      }
      return {};
    }
    return raw;
  }

  function loadSettings() {
    fetch("/api/settings")
      .then(function(r) { return r.json(); })
      .then(function(data) {
        settingsData = data || {};
        renderSettings();
      })
      .catch(function() { settingsData = {}; renderSettings(); });
  }

  function renderSettings() {
    var container = document.getElementById("settings-container");
    var html = "";

    for (var s = 0; s < SETTINGS_SECTIONS.length; s++) {
      var sec = SETTINGS_SECTIONS[s];
      var secData = flattenSettingsSection(sec.key, settingsData[sec.key]);

      html += '<div style="background:var(--surface-2);border:1px solid var(--surface-4);border-radius:var(--radius-m);padding:var(--sp-4);">';
      html += '<div style="font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:var(--sp-3);">' + escapeHTML(sec.label) + '</div>';

      for (var f = 0; f < sec.fields.length; f++) {
        var field = sec.fields[f];
        var val = secData[field.name] !== undefined ? secData[field.name] : "";
        if (typeof val === "number") val = String(val);

        html += '<div style="margin-bottom:var(--sp-3);">';
        html += '<label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:var(--sp-1);">' + escapeHTML(field.label) + '</label>';

        if (field.type === "select") {
          html += '<select id="setting-' + sec.key + '-' + field.name + '" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:13px;">';
          for (var o = 0; o < field.options.length; o++) {
            var sel = field.options[o] === val ? " selected" : "";
            html += '<option value="' + field.options[o] + '"' + sel + '>' + field.options[o] + '</option>';
          }
          html += '</select>';
        } else if (field.type === "textarea") {
          html += '<textarea id="setting-' + sec.key + '-' + field.name + '"';
          if (field.placeholder) html += ' placeholder="' + escapeHTML(field.placeholder) + '"';
          html += ' rows="4" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:13px;font-family:var(--font-mono);resize:vertical;">' + escapeHTML(String(val)) + '</textarea>';
        } else {
          html += '<input type="' + field.type + '" id="setting-' + sec.key + '-' + field.name + '" value="' + escapeHTML(String(val)) + '"';
          if (field.placeholder) html += ' placeholder="' + escapeHTML(field.placeholder) + '"';
          html += ' style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--surface-4);padding:var(--sp-2) var(--sp-3);border-radius:var(--radius-s);font-size:13px;">';
        }
        html += '</div>';
      }
      html += '</div>';
    }
    container.innerHTML = html;
  }

  var logPollers = {};
  function loadTaskLogs(taskId) {
    var container = document.getElementById("logs-" + taskId);
    if (!container) return;
    var lastId = 0;

    function poll() {
      if (!document.getElementById("logs-" + taskId)) {
        delete logPollers[taskId];
        return;
      }
      fetch("/api/tasks/" + taskId + "/logs?after=" + lastId)
        .then(function(r) { return r.json(); })
        .then(function(logs) {
          if (!logs || logs.length === 0) {
            if (lastId === 0) container.innerHTML = '<div style="color:var(--text-muted);">No logs yet.</div>';
            return;
          }
          if (lastId === 0) container.innerHTML = "";
          for (var i = 0; i < logs.length; i++) {
            var l = logs[i];
            var color = l.level === "error" ? "var(--red)" : "var(--text-secondary)";
            var ts = l.timestamp ? l.timestamp.substring(11, 19) : "";
            container.innerHTML += '<div style="color:' + color + '"><span style="color:var(--text-muted);">' + ts + '</span> ' + escapeHTML(l.message) + '</div>';
            lastId = l.id;
          }
          container.scrollTop = container.scrollHeight;
        })
        .catch(function() {});
    }

    poll();
    if (logPollers[taskId]) clearInterval(logPollers[taskId]);
    logPollers[taskId] = setInterval(poll, 2000);
  }

  window.stopTask = function(taskId) {
    fetch("/api/tasks/" + taskId + "/stop", { method: "POST" })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.error) { alert("Stop failed: " + data.error); return; }
        showSettingsModal(true, "Task stopped", "Task " + taskId + " has been stopped.");
      })
      .catch(function(err) { alert("Stop failed: " + err.message); });
  };

  window.retryTask = function(taskId) {
    fetch("/api/tasks/" + taskId + "/retry", { method: "POST" })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.error) { alert("Retry failed: " + data.error); return; }
        showSettingsModal(true, "Task re-started", "Task " + taskId + " is now running.");
      })
      .catch(function(err) { alert("Retry failed: " + err.message); });
  };

  window.saveAllSettings = function() {
    var payload = {};
    for (var s = 0; s < SETTINGS_SECTIONS.length; s++) {
      var sec = SETTINGS_SECTIONS[s];
      var secData = {};
      for (var f = 0; f < sec.fields.length; f++) {
        var field = sec.fields[f];
        var el = document.getElementById("setting-" + sec.key + "-" + field.name);
        if (!el) continue;
        var val = el.value;
        if (field.type === "number") {
          secData[field.name] = parseInt(val, 10) || 0;
        } else {
          secData[field.name] = val;
        }
      }
      payload[sec.key] = secData;
    }
    // repo URL 파싱: https://github.com/owner/repo.git → owner/repo
    if (payload.source && payload.source.repo) {
      var r = payload.source.repo.trim();
      var m = r.match(/github\.com[/:]([^/]+)\/([^/.]+)/);
      if (m) { r = m[1] + "/" + m[2]; }
      payload.source.repo = r;
      payload.source.platform = "github";
    }

    // Deploy: flat form → nested DeployConfig structure
    if (payload.deploy) {
      var d = payload.deploy;
      var method = d.method || "none";
      var commands = [];
      if (d.commands && d.commands.trim() !== "") {
        var lines = d.commands.split("\n");
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line !== "") {
            commands.push({ name: "step" + (i + 1), run: line });
          }
        }
      }
      var infraFiles = [];
      if (d.infra_files && d.infra_files.trim() !== "") {
        var parts = d.infra_files.split(",");
        for (var j = 0; j < parts.length; j++) {
          var p = parts[j].trim();
          if (p !== "") infraFiles.push(p);
        }
      }
      payload.deploy = {
        method: method === "none" ? "" : method,
        config: { commands: commands },
        infra_files: infraFiles
      };
    }

    // Test: flat form → TestConfig array
    if (payload.test) {
      var t = payload.test;
      if (t.run && t.run.trim() !== "") {
        payload.test = [{ type: t.type || "command", name: t.name || "Test", run: t.run }];
      } else {
        payload.test = [];
      }
    }

    fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: payload })
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        showSettingsModal(true, "Settings saved", "Restart rig serve for changes to take effect.");
      })
      .catch(function(err) {
        showSettingsModal(false, "Save failed", err.message);
      });
  };

  function showSettingsModal(success, title, msg) {
    document.getElementById("settings-modal-icon").textContent = success ? "\u2705" : "\u274C";
    document.getElementById("settings-modal-title").textContent = title;
    document.getElementById("settings-modal-msg").textContent = msg;
    document.getElementById("settings-modal").classList.add("modal--open");
  }
  window.closeSettingsModal = function() {
    document.getElementById("settings-modal").classList.remove("modal--open");
  };
  document.getElementById("settings-modal").addEventListener("click", function(e) {
    if (e.target === this) closeSettingsModal();
  });

  // ── AGENTS.md ──
  function loadAgentsPage() {
    var select = document.getElementById("agents-project");
    // Populate from projects or settings
    if (projects && projects.length > 0) {
      var html = "";
      for (var i = 0; i < projects.length; i++) {
        var p = projects[i];
        html += '<option value="' + escapeHTML(p.repo) + '">' + escapeHTML(p.name || p.repo) + '</option>';
      }
      select.innerHTML = html;
    } else {
      // Try loading from settings source.repo
      var repo = (settingsData.source && settingsData.source.repo) || "";
      select.innerHTML = '<option value="' + escapeHTML(repo) + '">' + escapeHTML(repo || "No project configured") + '</option>';
    }
    loadAgentsForProject();
  }

  window.loadAgentsForProject = function() {
    var repo = document.getElementById("agents-project").value;
    if (!repo) return;

    fetch("/api/agents/" + encodeURIComponent(repo))
      .then(function(r) { return r.json(); })
      .then(function(data) {
        document.getElementById("agents-content").value = data.content || "";
      })
      .catch(function() {
        document.getElementById("agents-content").value = "";
      });
  };

  window.saveAgents = function() {
    var repo = document.getElementById("agents-project").value;
    var content = document.getElementById("agents-content").value;

    fetch("/api/agents/" + encodeURIComponent(repo), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: content })
    })
      .then(function(r) { return r.json(); })
      .then(function() {
        var status = document.getElementById("agents-status");
        status.textContent = "Saved";
        status.style.display = "inline";
        setTimeout(function() { status.style.display = "none"; }, 3000);
      })
      .catch(function(err) { alert("Save failed: " + err.message); });
  };

  // ── Boot ──
  // Check if we're in setup mode
  fetch("/api/status")
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.configured) {
        showPage("settings");
      } else {
        loadConfig();
        loadProjects();
        fetchTasks();
        connectSSE();
      }
    })
    .catch(function() {
      loadConfig();
      loadProjects();
      fetchTasks();
      connectSSE();
    });
})();
</script>

</body>
</html>
